<html>
<head>
	<title>札幌市消防出動情報</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
	<link href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" rel="stylesheet"/>

	<script src="http://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

	<script src='https://unpkg.com/leaflet.markercluster@1.2.0/dist/leaflet.markercluster.js'></script>
	<link href="https://unpkg.com/leaflet.markercluster@1.2.0/dist/MarkerCluster.css" rel="stylesheet"/>
	<link href="https://unpkg.com/leaflet.markercluster@1.2.0/dist/MarkerCluster.Default.css" rel="stylesheet"/>

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
<style>
html, body  {
	width: 100%;
	height: 100%;
	padding: 0px;
	margin: 0px;
}
#map {
	width: 100%;
	height: 100%;
}

.info {
	padding: 6px 8px;
	font: 14px/16px Arial, Helvetica, sans-serif;
	background: white;
	background: rgba(255,255,255,0.8);
	box-shadow: 0 0 15px rgba(0,0,0,0.2);
	border-radius: 5px;
}

.action {
	line-height: 18px;
	color: #555;
}

.action i {
	width: 18px;
	height: 18px;
	float: left;
	margin-right: 8px;
	opacity: 0.7;
}
</style>
</head>
<body>

<div id="map"></div>

<hr/>
</body>

<script type="text/javascript">
	var mierune = L.tileLayer(
		"https://tile.mierune.co.jp/mierune_mono/{z}/{x}/{y}.png",
		//"https://tile.mierune.co.jp/mierune_normal/{z}/{x}/{y}.png",
		{
			attribution: "Maptiles by <a href='http://mierune.co.jp/' target='_blank'>MIERUNE</a>, under CC BY. Data by <a href='http://osm.org/copyright' target='_blank'>OpenStreetMap</a> contributors, under ODbL."
		}
	);

	var osm = L.tileLayer(
		'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
		{
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
			maxZoom: 18
		}
	);

	var map = L.map('map')
		.setView([43.080　, 141.350], 12)
		.addLayer(mierune);

	var baseMaps = {"Mierune": mierune, "OpenStreetMap":osm};
	var layerControl = L.control.layers(baseMaps).addTo(map);

	function getActionColor(f) {
		switch (f.properties.action) {
			case '火災出動':return 'red';
			case '警戒出動':return 'lime';
			case '車両火災出動':return 'orange';
			case '救助出動':return 'blue';
			case 'ガス漏れ出動':return 'yellow';
			case '救急隊支援出動':return 'magenta';
		}
	}

	//情報表示
	var info = L.control();
	info.onAdd = function(map) {
		this._div = L.DomUtil.create('div', 'info');
		//this.update();
		return　this._div;
	};
	info.addTo(map);

	//レジェンドの描画
	/*
	var legend = L.control({position: 'bottomleft'});
	legend.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'info action'),
			colors = ['red','lime','orange','blue','yellow','magenta'];
			labels = ['火災','警戒','車両火災','救助','ガス漏れ','救急隊支援'];
			for(var i=0; i<labels.length; i++) {
				div.innerHTML += '<i style="background:'+ colors[i] +'"></i>' +labels[i] +'<br/>';
			}
	    return div;
	};
	legend.addTo(map);
	*/

	function geoJsonPoint(data){
		var geoJson = L.geoJson(data,{
			pointToLayer: function(geoJsonPoint, latlng) {
				return L.circleMarker(latlng);
				//return L.marker(latlng);
			},
			
			style: function(feature) {
				return {
					"fillColor": getActionColor(feature), 
					"fillOpacity":0.8,
					"weight":1
				};
			},
			
			onEachFeature: function(feature, layer){
				layer.bindPopup(
					feature.properties.time +'<br/>' 
					+feature.properties.action+'<br/>'
					+feature.properties.address
				);
			}
		});
		return geoJson;
	}

	//geojsonを読み込んでマーカーを描画する
	function addActionGroup(files,name){
		var layerGroup = L.layerGroup();
		layerGroup.addTo(map);

		layerControl.addOverlay(layerGroup, name);

		files.forEach(function(file) {
			d3.json(file, function(err, data) {
				layerGroup.addLayer(geoJsonPoint(data));
			});
		});
	}

	//geojsonを読み込んでマーカーをクラスタで描画する
	function addMakerCluster(files)
	{
		var markerCluster = L.markerClusterGroup();

		files.forEach(function(file) {
			d3.json(file, function(err, data) {
				//var maxDistance = 300;
				//var clustered = turf.clustersDbscan(data, maxDistance);

				var options = {numberOfClusters: 7};
				var clustered = turf.clustersKmeans(data, options);

				var cluster_0 = turf.getCluster(clustered, {cluster: 0});

				clustered.features.forEach(function(f) {
					console.log(f.properties.cluster);
				});

				var geoJson = geoJsonPoint(data);
				markerCluster.addLayer(geoJson);
			});
		});
		map.addLayer(markerCluster);
	}

	/*
	addMakerCluster([
		"./data/20171201.geojson",
		"./data/20171202.geojson",
		"./data/20171203.geojson",
		"./data/20171204.geojson",
		"./data/20171205.geojson",
		"./data/20171206.geojson",
		"./data/20171207.geojson"
		]);
	*/
	
	/*
	addActionGroup([
		"./data/20171201.geojson",
		"./data/20171202.geojson", "./data/20171203.geojson",
		"./data/20171204.geojson", "./data/20171205.geojson"
		],'12/01-05');

	addActionGroup([
		"./data/20171206.geojson",
		"./data/20171207.geojson","./data/20171208.geojson",
		"./data/20171209.geojson","./data/20171210.geojson"
		],'12/06-10');

	addActionGroup([
		"./data/20171211.geojson",
		"./data/20171212.geojson","./data/20171213.geojson",
		"./data/20171214.geojson","./data/20171215.geojson"
		],'12/11-15');

	addActionGroup([
		"./data/20171216.geojson","./data/20171217.geojson",
		"./data/20171218.geojson","./data/20171219.geojson",
		],'12/16-');
	*/

	var geoPoints = [];
	for(var i=1; i<20; i++) {
		var day = ('00'+i).slice(-2);
		var file = "./data/201712"+day+".geojson";

		d3.json(file, function(err, data) {
			if (err) { 
				console.log(err); 
			}
			else {
				data.features.forEach(function(feature) {
					var intensity = 5;
					if (feature.properties.action == "火災出動") {
						intensity = 50;
					}
					else if (feature.properties.action == "車両火災出動") {
						intensity = 50;
					}
					else if (feature.properties.action == "ガス漏れ出動") {
						intensity = 30;
					}
					else if (feature.properties.action == "救助出動") {
						intensity = 30;
					}

					lat = feature.geometry.coordinates[1];
					lon = feature.geometry.coordinates[0];
					
					geoPoints.push([lat, lon, intensity]);
				});
			}
		});
	};

	var options = {radius: 15, blur: 15, maxZoom: 11}
	var heatLayer = L.heatLayer(geoPoints,options);
	heatLayer.addTo(map);

	var dateFormat = d3.timeFormat("%Y%m%d");
	console.log(dateFormat(new Date(2017, 11, 1)));

</script>

</html>