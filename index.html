<html>
<head>
	<title>札幌市消防出動情報</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
	<link href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" rel="stylesheet"/>
	
	<script src="http://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>


	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

<style>
html, body  {
	width: 100%;
	height: 100%;
	padding: 0px;
	margin: 0px;
}
#map {
	width: 100%;
	height: 100%;
}

.info {
	padding: 6px 8px;
	font: 14px/16px Arial, Helvetica, sans-serif;
	background: white;
	background: rgba(255,255,255,0.8);
	box-shadow: 0 0 15px rgba(0,0,0,0.2);
	border-radius: 5px;
}

.action {
	line-height: 18px;
	color: #555;
}

.action i {
	width: 18px;
	height: 18px;
	float: left;
	margin-right: 8px;
	opacity: 0.7;
}
</style>
</head>
<body>

<div id="map"></div>

<hr/>
</body>

<script type="text/javascript">
	var mierune = L.tileLayer(
		"https://tile.mierune.co.jp/mierune_mono/{z}/{x}/{y}.png",
		{
			attribution: "Maptiles by <a href='http://mierune.co.jp/' target='_blank'>MIERUNE</a>, under CC BY. Data by <a href='http://osm.org/copyright' target='_blank'>OpenStreetMap</a> contributors, under ODbL."
		}
	);

	var osm = L.tileLayer(
		'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
		{
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
			maxZoom: 18
		}
	);

	var map = L.map('map')
		.setView([43.080　, 141.350], 12)
		.addLayer(mierune);

	var baseMaps = {"Mierune": mierune, "OpenStreetMap":osm};
	var layerControl = L.control.layers(baseMaps).addTo(map);

	function getActionColor(f) {
		switch (f.properties.action) {
			case '火災出動':return 'red';
			case '警戒出動':return 'lime';
			case '車両火災出動':return 'orange';
			case '救助出動':return 'blue';
			case 'ガス漏れ出動':return 'yellow';
			case '救急隊支援出動':return 'magenta';
		}
	}

	//情報表示
	var info = L.control();
	info.onAdd = function(map) {
		this._div = L.DomUtil.create('div', 'info');
		//this.update();
		return　this._div;
	};
	info.addTo(map);

	//レジェンドの描画
	function showLegend() {
		var legend = L.control({position: 'bottomleft'});
		legend.onAdd = function (map) {
			var div = L.DomUtil.create('div', 'info action'),
				colors = ['red','lime','orange','blue','yellow','magenta'];
				labels = ['火災','警戒','車両火災','救助','ガス漏れ','救急隊支援'];
				for(var i=0; i<labels.length; i++) {
					div.innerHTML += '<i style="background:'+ colors[i] +'"></i>' +labels[i] +'<br/>';
				}
		    return div;
		};
		legend.addTo(map);
	}

	function geoJsonPoint(data){
		var geoJson = L.geoJson(data,{
			pointToLayer: function(geoJsonPoint, latlng) {
				return L.circleMarker(latlng);
				//return L.marker(latlng);
			},
			
			style: function(feature) {
				return {
					"fillColor": getActionColor(feature), 
					"fillOpacity":0.8,
					"weight":1
				};
			},
			
			onEachFeature: function(feature, layer){
				layer.bindPopup(
					feature.properties.time +'<br/>' 
					+feature.properties.action+'<br/>'
					+feature.properties.address
				);
			}
		});
		return geoJson;
	}

	//geojsonを読み込んでマーカーを描画する
	function addActionGroup(files,name){
		var layerGroup = L.layerGroup();
		layerGroup.addTo(map);

		layerControl.addOverlay(layerGroup, name);

		files.forEach(function(file) {
			d3.json(file, function(err, data) {
				layerGroup.addLayer(geoJsonPoint(data));
			});
		});
	}

	group1 = ["./data/20171201.geojson","./data/20171202.geojson","./data/20171203.geojson","./data/20171204.geojson","./data/20171205.geojson"];
	group2 = ["./data/20171206.geojson","./data/20171207.geojson","./data/20171208.geojson","./data/20171209.geojson","./data/20171210.geojson"];
	group3 = ["./data/20171211.geojson","./data/20171212.geojson","./data/20171213.geojson","./data/20171214.geojson","./data/20171215.geojson"];
	group4 = ["./data/20171216.geojson","./data/20171217.geojson","./data/20171218.geojson","./data/20171219.geojson","./data/20171220.geojson"];
	group5 = ["./data/20171221.geojson","./data/20171222.geojson","./data/20171223.geojson","./data/20171224.geojson","./data/20171225.geojson"];
	group6 = ["./data/20171226.geojson","./data/20171227.geojson","./data/20171228.geojson","./data/20171229.geojson", "./data/20171230.geojson","./data/20171231.geojson"];

	group7 = ["./data/20180101.geojson","./data/20180102.geojson","./data/20180103.geojson","./data/20180104.geojson","./data/20180105.geojson"];
	group8 = ["./data/20180106.geojson","./data/20180107.geojson","./data/20180108.geojson","./data/20180109.geojson","./data/20180110.geojson"];
	group9 = ["./data/20180111.geojson","./data/20180112.geojson","./data/20180113.geojson","./data/20180114.geojson","./data/20180115.geojson"];
	group10 = ["./data/20180116.geojson","./data/20180117.geojson","./data/20180118.geojson","./data/20180119.geojson","./data/20180120.geojson"];
	group11 = ["./data/20180121.geojson","./data/20180122.geojson","./data/20180123.geojson","./data/20180124.geojson","./data/20180125.geojson"];
	group12 = ["./data/20180126.geojson","./data/20180127.geojson","./data/20180128.geojson","./data/20180129.geojson","./data/20180130.geojson"];

	addActionGroup(group1,'12/01-05');
	addActionGroup(group2,'12/06-10');
	addActionGroup(group3,'12/11-15');
	addActionGroup(group4,'12/16-20');
	addActionGroup(group5,'12/21-25');
	addActionGroup(group6,'12/26-31');
	addActionGroup(group7,'1/1-5');
	addActionGroup(group8,'1/6-10');
	addActionGroup(group9,'1/11-15');
	addActionGroup(group10,'1/16-20');
	addActionGroup(group11,'1/21-25');
	addActionGroup(group12,'1/26-');
</script>

</html>
